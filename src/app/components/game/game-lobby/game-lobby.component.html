<p-toast />

<div class="lobby-container">
  <h1 class="lobby-title">
    <i class="pi pi-play"></i>
    Nouvelle Partie
  </h1>

  <!-- Mode Selector -->
  <div class="mode-selector">
    <p-button
      label="Local"
      icon="pi pi-desktop"
      [severity]="gameMode === 'local' ? 'primary' : 'secondary'"
      [outlined]="gameMode !== 'local'"
      (onClick)="gameMode = 'local'"
    />
    <p-button
      label="En ligne"
      icon="pi pi-globe"
      [severity]="gameMode === 'online' ? 'primary' : 'secondary'"
      [outlined]="gameMode !== 'online'"
      (onClick)="gameMode = 'online'"
    />
  </div>

  <!-- Online Multiplayer UI -->
  @if (gameMode === 'online') {
    <div class="online-section">
      <!-- Connection Status -->
      @if (connectionState === ConnectionState.DISCONNECTED) {
        <p-card>
          <ng-template #header>
            <div class="card-header">
              <i class="pi pi-wifi"></i>
              Connexion au serveur
            </div>
          </ng-template>
          <div class="connection-setup">
            <p>Connectez-vous au serveur multijoueur pour jouer en ligne.</p>
            <p-button
              label="Se connecter"
              icon="pi pi-sign-in"
              (onClick)="connectToServer()"
            />
          </div>
        </p-card>
      }

      <!-- Connected - Show Options -->
      @if (connectionState === ConnectionState.CONNECTED) {
        <p-card>
          <ng-template #header>
            <div class="card-header">
              <i class="pi pi-user"></i>
              Configuration
            </div>
          </ng-template>
          <div class="online-setup">
            <label>Votre nom</label>
            <input pInputText [(ngModel)]="playerName" placeholder="Entrez votre nom..." />

            <label>Votre deck</label>
            <p-select
              [options]="deckOptions"
              [(ngModel)]="selectedDeckId"
              optionLabel="label"
              optionValue="value"
              optionGroupLabel="label"
              optionGroupChildren="items"
              [group]="true"
              placeholder="Choisir un deck..."
              [style]="{ width: '100%' }"
            />

            <div class="online-actions">
              <p-button
                label="Cr√©er une salle"
                icon="pi pi-plus"
                [disabled]="!canCreateRoom"
                (onClick)="createRoom()"
              />
              <p-button
                label="Match al√©atoire"
                icon="pi pi-bolt"
                severity="success"
                [disabled]="!canCreateRoom"
                (onClick)="findRandomMatch()"
              />
            </div>

            <div class="join-room">
              <label>Rejoindre une salle</label>
              <div class="join-room-input">
                <input
                  pInputText
                  [(ngModel)]="roomCodeInput"
                  placeholder="Code de la salle (ex: ABC123)"
                  [style]="{ flex: 1 }"
                />
                <p-button
                  label="Rejoindre"
                  icon="pi pi-sign-in"
                  [disabled]="!canJoinRoom"
                  (onClick)="joinRoom()"
                />
              </div>
              <p-button
                label="üìã Parcourir les salles disponibles"
                [outlined]="true"
                severity="info"
                (onClick)="toggleLobbyBrowser()"
                [style]="{ width: '100%', marginTop: '0.5rem' }"
              />
            </div>

            <!-- Lobby Browser -->
            @if (showLobbyBrowser) {
              <div class="lobby-browser">
                <div class="browser-header">
                  <h3>Salles disponibles</h3>
                  <div class="browser-actions">
                    <p-button
                      icon="pi pi-refresh"
                      [rounded]="true"
                      [text]="true"
                      [loading]="loadingRooms"
                      (onClick)="loadAvailableRooms()"
                      pTooltip="Actualiser"
                    />
                  </div>
                </div>

                @if (loadingRooms && availableRooms.length === 0) {
                  <div class="loading-state">
                    <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
                    <p>Chargement...</p>
                  </div>
                } @else if (availableRooms.length === 0) {
                  <div class="empty-state">
                    <i class="pi pi-inbox" style="font-size: 3rem"></i>
                    <p>Aucune salle disponible</p>
                    <p class="hint">Cr√©ez une nouvelle salle ou r√©essayez plus tard</p>
                  </div>
                } @else {
                  <div class="rooms-list">
                    @for (room of availableRooms; track room.code) {
                      <div class="room-item">
                        <div class="room-info">
                          <div class="room-host">
                            <i class="pi pi-user"></i>
                            <strong>{{ room.hostName }}</strong>
                          </div>
                          <div class="room-deck">
                            <i class="pi pi-th-large"></i>
                            {{ getDeckName(room.hostDeckId) }}
                          </div>
                          <div class="room-time">
                            <i class="pi pi-clock"></i>
                            {{ formatTimeAgo(room.createdAt) }}
                          </div>
                        </div>
                        <div class="room-actions">
                          <p-button
                            label="Rejoindre"
                            icon="pi pi-sign-in"
                            size="small"
                            (onClick)="joinRoomFromBrowser(room)"
                          />
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </p-card>
      }

      <!-- In Room - Waiting for Opponent -->
      @if (connectionState === ConnectionState.IN_ROOM && isWaitingForOpponent) {
        <p-card>
          <ng-template #header>
            <div class="card-header">
              <i class="pi pi-clock"></i>
              En attente
            </div>
          </ng-template>
          <div class="waiting-room">
            <div class="room-code-display">
              <label>Code de la salle</label>
              <div class="code-box">
                <span class="code">{{ currentRoomCode }}</span>
                <p-button
                  icon="pi pi-copy"
                  [rounded]="true"
                  [text]="true"
                  (onClick)="copyRoomCode()"
                  pTooltip="Copier le code"
                />
              </div>
            </div>
            <p class="waiting-message">
              <i class="pi pi-spin pi-spinner"></i>
              En attente d'un adversaire...
            </p>
            <p class="hint">Partagez le code de la salle avec un ami</p>
            <p-button
              label="Annuler"
              icon="pi pi-times"
              severity="danger"
              [outlined]="true"
              (onClick)="leaveRoom()"
            />
          </div>
        </p-card>
      }

      <!-- Searching for Match -->
      @if (isSearchingMatch) {
        <p-card>
          <ng-template #header>
            <div class="card-header">
              <i class="pi pi-search"></i>
              Recherche en cours
            </div>
          </ng-template>
          <div class="waiting-room">
            <p class="waiting-message">
              <i class="pi pi-spin pi-spinner"></i>
              Recherche d'un adversaire...
            </p>
            <p-button
              label="Annuler"
              icon="pi pi-times"
              severity="danger"
              [outlined]="true"
              (onClick)="leaveRoom()"
            />
          </div>
        </p-card>
      }

      <!-- In Room - Opponent Found -->
      @if (connectionState === ConnectionState.IN_ROOM && !isWaitingForOpponent && currentRoomCode) {
        <p-card>
          <ng-template #header>
            <div class="card-header">
              <i class="pi pi-users"></i>
              Salle: {{ currentRoomCode }}
            </div>
          </ng-template>
          <div class="room-ready">
            <p class="success-message">
              <i class="pi pi-check-circle"></i>
              Adversaire trouv√©: {{ opponentName }}
            </p>
            <p class="hint">La partie va commencer...</p>
          </div>
        </p-card>
      }
    </div>
  }

  <!-- Local Game UI -->
  @if (gameMode === 'local') {
    <!-- Starter Decks -->
    @if (starterDecks.length > 0) {
    <div class="starter-section">
      <h2 class="starter-title">Decks Pr√©d√©finis</h2>
      <div class="starter-grid">
        @for (deck of starterDecks; track deck.id) {
          <div class="starter-card">
            <div class="starter-name">{{ deck.name }}</div>
            <div class="starter-desc">{{ deck.description }}</div>
            <div class="starter-domains">
              @for (d of deck.domains; track d) {
                <p-tag [value]="d" severity="info" />
              }
            </div>
            <div class="starter-actions">
              <p-button
                label="J1"
                icon="pi pi-user"
                size="small"
                severity="secondary"
                [outlined]="p1DeckId !== deck.id"
                (onClick)="selectStarterDeck(deck.id, 1)"
              />
              <p-button
                label="J2"
                icon="pi pi-user"
                size="small"
                severity="secondary"
                [outlined]="p2DeckId !== deck.id"
                (onClick)="selectStarterDeck(deck.id, 2)"
              />
            </div>
          </div>
        }
      </div>
    </div>
  }

  <div class="lobby-grid">
    <!-- Player 1 -->
    <p-card class="player-card">
      <ng-template #header>
        <div class="player-header p1">Joueur 1</div>
      </ng-template>
      <div class="player-setup">
        <label>Nom</label>
        <input pInputText [(ngModel)]="p1Name" placeholder="Joueur 1" />

        <label>Deck</label>
        <p-select
          [options]="deckOptions"
          [(ngModel)]="p1DeckId"
          optionLabel="label"
          optionValue="value"
          optionGroupLabel="label"
          optionGroupChildren="items"
          [group]="true"
          placeholder="Choisir un deck..."
          [style]="{ width: '100%' }"
          (onChange)="onP1DeckChange()"
        />

        @if (p1Validation) {
          @if (p1Validation.isValid) {
            <p-tag severity="success" value="Deck valide" />
          } @else {
            <div class="validation-errors">
              @for (err of p1Validation.errors; track err) {
                <p-tag severity="danger" [value]="err" />
              }
            </div>
          }
        }
      </div>
    </p-card>

    <!-- Player 2 -->
    <p-card class="player-card">
      <ng-template #header>
        <div class="player-header p2">Joueur 2</div>
      </ng-template>
      <div class="player-setup">
        <label>Nom</label>
        <input pInputText [(ngModel)]="p2Name" placeholder="Joueur 2" />

        <label>Deck</label>
        <p-select
          [options]="deckOptions"
          [(ngModel)]="p2DeckId"
          optionLabel="label"
          optionValue="value"
          optionGroupLabel="label"
          optionGroupChildren="items"
          [group]="true"
          placeholder="Choisir un deck..."
          [style]="{ width: '100%' }"
          (onChange)="onP2DeckChange()"
        />

        @if (p2Validation) {
          @if (p2Validation.isValid) {
            <p-tag severity="success" value="Deck valide" />
          } @else {
            <div class="validation-errors">
              @for (err of p2Validation.errors; track err) {
                <p-tag severity="danger" [value]="err" />
              }
            </div>
          }
        }
      </div>
    </p-card>
  </div>

  <div class="lobby-actions">
    <p-button
      label="Commencer la Partie"
      icon="pi pi-play"
      [disabled]="!canStart"
      (onClick)="startGame()"
      severity="success"
      size="large"
    />
    <p-button
      label="Partie Rapide"
      icon="pi pi-bolt"
      (onClick)="startQuickGame()"
      severity="secondary"
      size="large"
    />
    <p-button
      label="Jouer contre l'IA"
      icon="pi pi-android"
      (onClick)="startAiGame()"
      severity="help"
      size="large"
    />
    <p-button
      label="Tutoriel"
      icon="pi pi-question-circle"
      (onClick)="startTutorial()"
      severity="info"
      size="large"
    />
  </div>

    @if (deckOptions.length === 0 && starterDecks.length === 0) {
      <div class="no-decks">
        <p>Aucun deck sauvegard√©. Cr√©ez un deck pour jouer avec des decks personnalis√©s.</p>
        <p-button label="Aller au Constructeur" icon="pi pi-objects-column" routerLink="/deck-builder" severity="info" />
      </div>
    }
  }
</div>
