<div class="stats-container">
  <div class="header">
    <h1>Statistiques & Historique</h1>
    <div class="header-actions">
      <p-button
        label="Exporter"
        icon="pi pi-download"
        severity="secondary"
        [outlined]="true"
        (onClick)="exportStats()"
      />
      <p-button
        label="R√©initialiser"
        icon="pi pi-trash"
        severity="danger"
        [outlined]="true"
        (onClick)="confirmClearStats()"
      />
      <p-button
        label="Retour"
        icon="pi pi-arrow-left"
        severity="secondary"
        (onClick)="goBack()"
      />
    </div>
  </div>

  @if (playerStats && playerStats.totalGames > 0) {
    <p-tabs value="0">
      <p-tablist>
        <p-tab value="0">Vue d'ensemble</p-tab>
        <p-tab value="1">Historique des Parties</p-tab>
        <p-tab value="2">Decks</p-tab>
        <p-tab value="3">üèÜ Classement Global</p-tab>
        <p-tab value="4">üìú Parties R√©centes</p-tab>
      </p-tablist>
      <p-tabpanels>
        <p-tabpanel value="0">
        <div class="overview-grid">
          <p-card header="Parties Jou√©es">
            <div class="stat-value">{{ playerStats.totalGames }}</div>
            <div class="stat-label">Total</div>
          </p-card>

          <p-card header="Taux de Victoire">
            <div class="stat-value" [class]="'text-' + getWinRateColor(playerStats.winRate)">
              {{ (playerStats.winRate * 100).toFixed(1) }}%
            </div>
            <div class="stat-label">{{ playerStats.totalWins }}V / {{ playerStats.totalLosses }}D</div>
          </p-card>

          <p-card header="S√©rie Actuelle">
            <div class="stat-value">{{ playerStats.currentWinStreak }}</div>
            <div class="stat-label">Victoires cons√©cutives</div>
          </p-card>

          <p-card header="Record">
            <div class="stat-value">{{ playerStats.longestWinStreak }}</div>
            <div class="stat-label">Meilleure s√©rie</div>
          </p-card>

          <p-card header="Dur√©e Moyenne">
            <div class="stat-value">{{ playerStats.averageGameLength.toFixed(1) }}</div>
            <div class="stat-label">Tours par partie</div>
          </p-card>

          <p-card header="Parties vs IA">
            <div class="stat-value">{{ playerStats.aiGames }}</div>
            <div class="stat-label">{{ playerStats.aiWins }} victoires</div>
          </p-card>
        </div>
        </p-tabpanel>

        <p-tabpanel value="1">
        <p-table
          [value]="playerStats.recentGames"
          [paginator]="true"
          [rows]="10"
          [rowsPerPageOptions]="[5, 10, 20]"
          styleClass="p-datatable-sm"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>Date</th>
              <th>R√©sultat</th>
              <th>Adversaire</th>
              <th>Type</th>
              <th>Deck</th>
              <th>Tours</th>
              <th>Dur√©e</th>
              <th>R√©putation</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-game>
            <tr [class.victory-row]="game.won" [class.defeat-row]="!game.won">
              <td>{{ formatDate(game.timestamp) }}</td>
              <td>
                <span [class]="game.won ? 'badge badge-success' : 'badge badge-danger'">
                  {{ game.won ? 'Victoire' : 'D√©faite' }}
                </span>
              </td>
              <td>{{ game.opponentName }}</td>
              <td>
                <span class="badge badge-info">
                  {{ game.isAiGame ? 'vs IA' : 'vs Joueur' }}
                </span>
              </td>
              <td>{{ getDeckName(game.playerDeckId) }}</td>
              <td>{{ game.turnCount }}</td>
              <td>{{ formatDuration(game.duration) }}</td>
              <td>
                <span class="reputation-display">
                  {{ game.finalReputation }} / {{ game.opponentFinalReputation }}
                </span>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="8" class="empty-message">
                Aucune partie enregistr√©e
              </td>
            </tr>
          </ng-template>
        </p-table>
        </p-tabpanel>

        <p-tabpanel value="2">
        <div class="decks-stats">
          @for (deckId of playerStats.favoriteDecks; track deckId) {
            @if (getDeckName(deckId) !== 'Deck Inconnu') {
              <p-card [header]="getDeckName(deckId)">
                @if (statsService.getDeckStats(deckId); as deckStats) {
                  <div class="deck-stats-grid">
                    <div class="deck-stat">
                      <div class="deck-stat-value">{{ deckStats.gamesPlayed }}</div>
                      <div class="deck-stat-label">Parties</div>
                    </div>
                    <div class="deck-stat">
                      <div class="deck-stat-value" [class]="'text-' + getWinRateColor(deckStats.winRate)">
                        {{ (deckStats.winRate * 100).toFixed(1) }}%
                      </div>
                      <div class="deck-stat-label">Taux de Victoire</div>
                    </div>
                    <div class="deck-stat">
                      <div class="deck-stat-value">{{ deckStats.wins }}V / {{ deckStats.losses }}D</div>
                      <div class="deck-stat-label">R√©sultats</div>
                    </div>
                    <div class="deck-stat">
                      <div class="deck-stat-value">{{ deckStats.averageTurns.toFixed(1) }}</div>
                      <div class="deck-stat-label">Tours Moy.</div>
                    </div>
                  </div>
                }
              </p-card>
            }
          }
        </div>
        </p-tabpanel>

        <p-tabpanel value="3">
          @if (serverLoading) {
            <div class="loading-state">
              <i class="pi pi-spin pi-spinner" style="font-size: 3rem"></i>
              <p>Chargement du classement...</p>
            </div>
          } @else if (serverError) {
            <div class="error-state">
              <i class="pi pi-exclamation-triangle"></i>
              <p>{{ serverError }}</p>
              <p-button
                label="R√©essayer"
                icon="pi pi-refresh"
                (onClick)="loadServerStats()"
              />
            </div>
          } @else {
            <p-table
              [value]="leaderboard"
              [paginator]="true"
              [rows]="10"
              styleClass="p-datatable-sm"
            >
              <ng-template pTemplate="header">
                <tr>
                  <th>Rang</th>
                  <th>Joueur</th>
                  <th>Parties</th>
                  <th>Victoires</th>
                  <th>D√©faites</th>
                  <th>Taux de victoire</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-player let-rowIndex="rowIndex">
                <tr>
                  <td>
                    <strong>{{ rowIndex + 1 }}</strong>
                  </td>
                  <td>{{ player.player_name }}</td>
                  <td>{{ player.total_games }}</td>
                  <td class="wins">{{ player.wins }}</td>
                  <td class="losses">{{ player.losses }}</td>
                  <td>
                    <span class="win-rate-badge" [class.high]="player.win_rate >= 60" [class.medium]="player.win_rate >= 40 && player.win_rate < 60">
                      {{ player.win_rate.toFixed(1) }}%
                    </span>
                  </td>
                </tr>
              </ng-template>
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="6" class="empty-message">
                    Aucun joueur dans le classement. Jouez des parties en ligne pour appara√Ætre !
                  </td>
                </tr>
              </ng-template>
            </p-table>
          }
        </p-tabpanel>

        <p-tabpanel value="4">
          @if (serverLoading) {
            <div class="loading-state">
              <i class="pi pi-spin pi-spinner" style="font-size: 3rem"></i>
              <p>Chargement des parties r√©centes...</p>
            </div>
          } @else if (serverError) {
            <div class="error-state">
              <i class="pi pi-exclamation-triangle"></i>
              <p>{{ serverError }}</p>
              <p-button
                label="R√©essayer"
                icon="pi pi-refresh"
                (onClick)="loadServerStats()"
              />
            </div>
          } @else {
            <p-table
              [value]="recentMatches"
              [paginator]="true"
              [rows]="10"
              styleClass="p-datatable-sm"
            >
              <ng-template pTemplate="header">
                <tr>
                  <th>Date</th>
                  <th>Joueur 1</th>
                  <th>Joueur 2</th>
                  <th>Vainqueur</th>
                  <th>Tours</th>
                  <th>Dur√©e</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-match>
                <tr>
                  <td class="date-cell">{{ formatDate(match.end_time) }}</td>
                  <td>{{ match.player1_name }}</td>
                  <td>{{ match.player2_name }}</td>
                  <td>
                    <span class="winner-badge" [class.draw]="!match.winner_id">
                      {{ getWinnerName(match) }}
                    </span>
                  </td>
                  <td>{{ match.turn_count }}</td>
                  <td>{{ getMatchDuration(match) }}</td>
                </tr>
              </ng-template>
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="6" class="empty-message">
                    Aucune partie r√©cente enregistr√©e.
                  </td>
                </tr>
              </ng-template>
            </p-table>
          }
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  } @else {
    <p-card>
      <div class="empty-state">
        <i class="pi pi-chart-line" style="font-size: 4rem; color: var(--text-color-secondary);"></i>
        <h2>Aucune statistique disponible</h2>
        <p>Jouez votre premi√®re partie pour commencer √† accumuler des statistiques !</p>
        <p-button
          label="Commencer une partie"
          icon="pi pi-play"
          (onClick)="goBack()"
        />
      </div>
    </p-card>
  }
</div>

<p-dialog
  header="R√©initialiser les statistiques"
  [(visible)]="showClearDialog"
  [modal]="true"
  [style]="{ width: '450px' }"
>
  <p>√ätes-vous s√ªr de vouloir supprimer toutes les statistiques ? Cette action est irr√©versible.</p>
  <ng-template pTemplate="footer">
    <p-button
      label="Annuler"
      severity="secondary"
      [outlined]="true"
      (onClick)="showClearDialog = false"
    />
    <p-button
      label="Confirmer"
      severity="danger"
      (onClick)="clearStats()"
    />
  </ng-template>
</p-dialog>
